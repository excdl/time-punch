<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>LIFF 打卡系統</title>
  <script src="https://static.line-scdn.net/liff/edge/2.22/sdk.js"></script>
</head>
<body>
  <h1>LIFF 打卡系統</h1>
  <p id="user-info"></p>

  <button onclick="clockIn('上班')">上班</button>
  <button onclick="clockIn('下班')">下班</button>
  <button onclick="clockIn('加班上班')">加班上班</button>
  <button onclick="clockIn('加班下班')">加班下班</button>
  <button onclick="getJobOpportunities()">查詢工作機會</button>

  <pre id="job-list"></pre>

  <script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxiCw_ru-Y5bmzMZH8lXqYdzVm0FDCchz4V5duUnAwAJQEzOzAi3dn2_7X39tiRHxey/exec"; // 替換成你的 GAS Web App URL

    async function main() {
      await liff.init({ liffId: "2008493252-eAMXGMPd" }); // 替換成你的 LIFF ID
      if (!liff.isLoggedIn()) liff.login();
      else {
        const profile = await liff.getProfile();
        document.getElementById('user-info').innerText = `Hi, ${profile.displayName} (ID: ${profile.userId})`;
        window.userProfile = profile;
      }
    }

    // 取得使用者 IP
    async function getUserIP() {
      try {
        const res = await fetch("https://api.ipify.org?format=json");
        const data = await res.json();
        return data.ip || "無法取得IP";
      } catch (err) {
        return "無法取得IP";
      }
    }

    async function clockIn(action) {
      const ip = await getUserIP();  // 抓 IP
      const payload = {
        type: "clock",
        userId: window.userProfile.userId,
        userName: window.userProfile.displayName,
        action: action,
        ip: ip
      };

      const res = await fetch(GAS_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      const data = await res.json();
      alert(data.status + ": " + (data.message || ""));
    }

    async function getJobOpportunities() {
      const payload = { type: "job" };
      const res = await fetch(GAS_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      const data = await res.json();
      document.getElementById("job-list").innerText = data.status === "success" ? data.message : "查詢失敗";
    }

    main();
  </script>
</body>
</html>
