<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<title>å¥‡å¯æ™ºèƒ½æ‰“å¡</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style>
  body { font-family: Arial,sans-serif; text-align:center; padding:20px; }
</style>
</head>
<body>
<h3>è¬è¬ä½¿ç”¨å¥‡å¯æ™ºèƒ½æ‰“å¡ç³»çµ±</h3>
<p id="status">åˆå§‹åŒ–ä¸­...</p>
<p id="ipStatus"></p>

<script>
const API_ENDPOINT = "https://script.google.com/macros/s/AKfycbyW-RPnWbUP3tDk1gnWDs-wnIIXVn-8nVu-Ce1IvaRAGvQrnewbbrCvY8y_6RGS_pJO/exec";
const COMPANY_IPS = ["43.227.24.78","43.226.232.126"];
let userIpCache = null;

// å–å¾— IP
async function getUserIP() {
  if (userIpCache) return userIpCache;
  try {
    const res = await fetch("https://api.ipify.org?format=json");
    const data = await res.json();
    userIpCache = data.ip;
    return data.ip;
  } catch (err) {
    console.error(err);
    return "æœªçŸ¥";
  }
}

// LIFF åˆå§‹åŒ–
async function initLiff() {
  await liff.init({ liffId: "2008493252-eAMXGMPd" });
  if (!liff.isLoggedIn()) {
    liff.login();
  } else {
    const profile = await liff.getProfile();
    document.getElementById("status").textContent = `æ­¡è¿ ${profile.displayName}ï¼Œæº–å‚™æ‰“å¡...`;
    startClockIn(profile);
  }
}

// æ‰“å¡
async function startClockIn(profile) {
  const ip = await getUserIP();
  const now = new Date();
  const date = now.toLocaleDateString("zh-TW");
  const time = now.toLocaleTimeString("zh-TW");

  // é¡¯ç¤ºå…¬å¸ç¶²è·¯æˆ–ç•°åœ°
  if (COMPANY_IPS.includes(ip)) {
    document.getElementById("ipStatus").innerHTML = `<span style="color:green;font-weight:bold">å·²é€£æ¥å…¬å¸ç¶²è·¯</span>`;
  } else {
    document.getElementById("ipStatus").innerHTML = `<span style="color:orange;font-weight:bold">ç•°åœ°æ‰“å¡</span>`;
  }

  const payload = {
    ip: ip,
    lineId: profile.userId,
    name: profile.displayName,
    date: date,
    time: time
  };

  try {
    const res = await fetch(API_ENDPOINT, {
      method: "POST",
      body: JSON.stringify(payload)
    });
    const result = await res.json();
    if (result.success) {
      Swal.fire({
        icon: "success",
        title: "ğŸ‰ æ‰“å¡æˆåŠŸï¼",
        html: `æ™‚é–“ï¼š${date} ${time}<br>IPï¼š${ip}`,
        timer: 3000,
        showConfirmButton: false
      });
    } else {
      Swal.fire({
        icon: "warning",
        title: "âš  æ‰“å¡å¤±æ•—",
        html: result.message,
        timer: 3000,
        showConfirmButton: false
      });
    }
  } catch (err) {
    console.error(err);
    Swal.fire({
      icon: "error",
      title: "âŒ ç™¼ç”ŸéŒ¯èª¤",
      html: "è«‹é€šçŸ¥ç®¡ç†å“¡",
      timer: 3000,
      showConfirmButton: false
    });
  }
}

// åˆå§‹åŒ–
window.onload = initLiff;
</script>
</body>
</html>

